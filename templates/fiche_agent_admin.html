{% extends "base.html" %}
{% block content %}

<h2>{{ agent.prenom }} {{ agent.nom }}</h2>

<h3>Matériel actuellement affecté</h3>

<table>
<tr>
<th>Nom</th>
<th>Série</th>
<th>Type</th>
<th>Contrôle EPI</th>
<th>Qté</th>
<th>Actions</th>
</tr>

{% for m in materiels %}
<tr>
<td>{{ m.nom }}</td>
<td>{{ m.numero_serie }}</td>
<td>{{ m.type }}</td>
<td>{{ m.date_controle }}</td>
<td><strong>{{ m.quantite }}</strong></td>

<td>

<!-- STOCK / REFORME -->

<form method="POST" action="/action_materiel" style="display:inline">

<input type="hidden" name="id" value="{{ m.id }}">

<input type="number"
       name="qte"
       min="1"
       max="{{ m.quantite }}"
       value="1"
       style="width:60px">

<button name="action" value="stock">Stock</button>
<button name="action" value="reforme">Réformer</button>

</form>

</td>
</tr>
{% endfor %}
</table>

<hr>

<h3>Demandes d’échange</h3>

<table>
<tr>
<th>Date</th>
<th>Matériel</th>
<th>Commentaire</th>
<th>Statut</th>
<th>Action</th>
</tr>

{% for e in echanges %}
<tr>
<td>{{ e.date[:16] }}</td>
<td>{{ e.ancien_materiel }}</td>
<td>{{ e.commentaire }}</td>

<td>
{% if e.statut == "en_attente" %}
<span style="color:orange">En attente</span>
{% elif e.statut == "valide" %}
<span style="color:green">Validé</span>
{% elif e.statut == "refuse" %}
<span style="color:red">Refusé</span>
{% else %}
{{ e.statut }}
{% endif %}
</td>

<td>

{% if e.statut == "en_attente" %}
<form method="POST" action="/admin/demande_echange" style="display:inline">

<input type="hidden" name="id" value="{{ e.id }}">

<button name="action" value="valide">✅ Valider</button>
<button name="action" value="refuse">❌ Refuser</button>

</form>
{% endif %}

</td>
</tr>
{% endfor %}
</table>

<hr>

<h3>Historique</h3>

<table>
<tr>
<th>Date</th>
<th>Matériel</th>
<th>Action</th>
</tr>

{% for h in historique %}
<tr>
<td>{{ h.date[:16] }}</td>
<td>{{ h.materiel }}</td>
<td>{{ h.action }}</td>
</tr>
{% endfor %}
</table>

{% endblock %}
